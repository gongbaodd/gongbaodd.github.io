{"posts":[{"id":"2020/01/05/CloudFlare-https.md","slug":"2020/01/05/cloudflare-https","body":"# 利用CloudFlare实现网站https访问\n\n## 配置DNS指向CloudFlare\n\n首先登入CloudFlare的时候，会被要求更改网站的DNS为cloudflare中。需要登入到自己网站的域名配置中修改DNS到CloudFlare下。\n\n配置成功后，收到CloudFlare的确认邮件，打开DNS，将Proxy status都打开。\n\n## 配置https-only\n\n打开CloudFlare的TLS选项，选择encryption mode为flexible，就是服务器到cloudflare不加密（只要cloudflare不作恶，我就OK），在Edge Certificates里面选择Always use https即可。\n\n## 配置防火墙只允许cloudflare的IP\n\n这里没配置成功，留个坑以后补全。\n\n安装firewalld\n\n```\nsudo apt install firewalld\nsudo systemctl start firewalld\nsudo systemctl enable firewalld\n```\n\n接下来执行以下脚本为cloudflare增加至白名单\n\n```shell\n!#/bin/bash\n\nfor i in $(curl \"https://www.cloudflare.com/ips-v4\");\ndo\nsudo firewall-cmd --permanent --zone=public --add-rich-rule='rule family=\"ipv4\" source address=\"'$i'\" port port=80 protocol=tcp accept';\nsudo firewall-cmd --permanent --zone=public --add-source=$i;\ndone\n\nfor i in $(curl \"https://www.cloudflare.com/ips-v6\");\ndo\nsudo firewall-cmd --permanent --zone=public --add-rich-rule='rule family=\"ipv6\" source address=\"'$i'\" port port=80 protocol=tcp accept';\nsudo firewall-cmd --permanent --zone=public --add-source=$i;\ndone\n\nsudo firewall-cmd --permanent --change-zone=eth0 --zone=public\n\nsudo firewall-cmd --reload\n\nfirewall-cmd --zone=public --list-all\n```","collection":"blog","data":{"type":"post","category":"tech"}}]}