<!DOCTYPE html><html lang="en" class="h-full relative" data-astro-cid-d3haqyqs><head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v3.5.0"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- Font preloads --><!-- <link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin />
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin /> --><!-- Canonical URL --><link rel="canonical" href="https://growgen.xyz/fe/2020/02/10/actix-web-rust-web/"><!-- Primary Meta Tags --><title>GrowGen | 给我整 | 利用 actix_web 使用 rust 编写 web 应用</title><meta name="title" content="GrowGen | 给我整 | 利用 actix_web 使用 rust 编写 web 应用"><meta name="description" content="最近我一直在实践 rust 相关的内容，本来想写一篇类似于scrapy 的文章，后来发现内容有点多，仅仅一篇文章兜不住，干脆写一个系列好了。

使用 Rust 的工具

rustup

使用 chocolatey 安装，安装好以后只是处理好..."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://growgen.xyz/fe/2020/02/10/actix-web-rust-web/"><meta property="og:title" content="GrowGen | 给我整 | 利用 actix_web 使用 rust 编写 web 应用"><meta property="og:description" content="最近我一直在实践 rust 相关的内容，本来想写一篇类似于scrapy 的文章，后来发现内容有点多，仅仅一篇文章兜不住，干脆写一个系列好了。

使用 Rust 的工具

rustup

使用 chocolatey 安装，安装好以后只是处理好..."><meta property="og:image" content="https://growgen.xyz/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://growgen.xyz/fe/2020/02/10/actix-web-rust-web/"><meta property="twitter:title" content="GrowGen | 给我整 | 利用 actix_web 使用 rust 编写 web 应用"><meta property="twitter:description" content="最近我一直在实践 rust 相关的内容，本来想写一篇类似于scrapy 的文章，后来发现内容有点多，仅仅一篇文章兜不住，干脆写一个系列好了。

使用 Rust 的工具

rustup

使用 chocolatey 安装，安装好以后只是处理好..."><meta property="twitter:image" content="https://growgen.xyz/blog-placeholder-1.jpg"><script>
      const getThemePreference = () => {
        const stored = localStorage?.getItem('theme')
        if (stored) {
          return stored
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
      }
      const isDark = () => getThemePreference() === 'dark'
      document.documentElement.classList[isDark() ? 'add' : 'remove']('dark')
    
      if(localStorage) {
        const observer = new MutationObserver(() => {
          const isDark = document.documentElement.classList.contains('dark')
          localStorage.setItem('theme', isDark ? 'dark' : 'light')
        })
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] })
      }
    </script><link rel="stylesheet" href="/_astro/_slug_.74c705b0.css" />
<link rel="stylesheet" href="/_astro/_slug_.28853c60.css" /></head><body class="min-h-full grid grid-cols-1" data-astro-cid-d3haqyqs><header class="h-16 sticky p-0 px-4 z-10 top-0  bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60" data-astro-cid-3ef6ksr2><nav class="flex items-center justify-between" data-astro-cid-3ef6ksr2><h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>GrowGen | 给我整</a></h2><div class="flex items-center gap-4" data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Home</a><a href="/all" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Blog</a><style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var b=Object.defineProperty;var f=(c,o,i)=>o in c?b(c,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[o]=i;var l=(c,o,i)=>(f(c,typeof o!="symbol"?o+"":o,i),i);var p;{let c={0:t=>m(t),1:t=>i(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(i(t)),5:t=>new Set(i(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[e,r]=t;return e in c?c[e](r):void 0},i=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,r])=>[e,o(r)]));customElements.get("astro-island")||customElements.define("astro-island",(p=class extends HTMLElement{constructor(){super(...arguments);l(this,"Component");l(this,"hydrator");l(this,"hydrate",async()=>{var d;if(!this.hydrator||!this.isConnected)return;let e=(d=this.parentElement)==null?void 0:d.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let r=this.querySelectorAll("astro-slot"),a={},h=this.querySelectorAll("template[data-astro-template]");for(let n of h){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("data-astro-template")||"default"]=n.innerHTML,n.remove())}for(let n of r){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("name")||"default"]=n.innerHTML)}let u;try{u=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(n){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),n),n}await this.hydrator(this)(this.Component,u,a,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});l(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),r.disconnect(),this.childrenConnectedCallback()},r=new MutationObserver(()=>{var a;((a=this.lastChild)==null?void 0:a.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});r.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),r=this.getAttribute("client");if(Astro[r]===void 0){window.addEventListener(`astro:${r}`,()=>this.start(),{once:!0});return}Astro[r](async()=>{let a=this.getAttribute("renderer-url"),[h,{default:u}]=await Promise.all([import(this.getAttribute("component-url")),a?import(a):()=>()=>{}]),d=this.getAttribute("component-export")||"default";if(!d.includes("."))this.Component=h[d];else{this.Component=h;for(let n of d.split("."))this.Component=this.Component[n]}return this.hydrator=u,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},l(p,"observedAttributes",["props"]),p))}})();</script><astro-island uid="1831nl" prefix="r0" component-url="/_astro/DarkModeToggle.123dfc23.js" component-export="ModeToggle" renderer-url="/_astro/client.97c1142b.js" props="{&quot;data-astro-cid-3ef6ksr2&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeToggle&quot;,&quot;value&quot;:true}" await-children=""><button class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10" type="button" id="radix-:r0R0:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button><!--astro:end--></astro-island></div></nav></header><main class="min-h-full grid grid-cols-1 justify-items-center"><article class="markdown-body max-w-6xl"><h1 id="利用-actix_web-使用-rust-编写-web-应用">利用 actix_web 使用 rust 编写 web 应用</h1>
<p>最近我一直在实践 rust 相关的内容，本来想写一篇类似于<a href="http://gongbaodd.github.io/tech/2020/02/04/Windows%E4%B8%8A%E4%BD%BF%E7%94%A8scrapy%E7%88%AC%E7%BD%91%E9%A1%B5.html" rel="noopener noreferrer nofollow" target="_blank">scrapy 的文章</a>，后来发现内容有点多，仅仅一篇文章兜不住，干脆写一个系列好了。</p>
<h2 id="使用-rust-的工具">使用 Rust 的工具</h2>
<h3 id="rustup">rustup</h3>
<p>使用 chocolatey 安装，安装好以后只是处理好了 rustup，后面的工具链还要用再次处理。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">choco</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> rust</span></span></code></pre>
<p>关于 rustup 的使用，可以查看<a href="https://github.com/rust-lang/rustup/blob/master/README.md" rel="noopener noreferrer nofollow" target="_blank">文档</a>，包括如何做交叉编译都可以使用这个工具完成。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">rustup</span><span style="color:#9ECBFF"> toolchain</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> stable-msvc</span></span></code></pre>
<h3 id="cratesio">crates.io</h3>
<p><a href="https://crates.io/" rel="noopener noreferrer nofollow" target="_blank">crates.io</a> 是 rust 的模块库，没啥可说的。</p>
<h3 id="cargo">cargo</h3>
<p>cargo 是 rust 的包管理工具。以下是几个 cargo 经常使用的命令。</p>
<ul>
<li><code>cargo new [project name]</code>，新建一个项目。</li>
<li><code>cargo init</code>，初始化一个项目。</li>
<li><code>cargo clean</code>，清理编译文件（相信我，这个会经常用）。</li>
<li><code>cargo run</code>，编译并运行 main 文件。</li>
<li><code>cargo run --bin [helper file name]</code>，直接执行 bin 文件夹下的文件。</li>
<li><code>cargo build</code>，编译文件。</li>
<li><code>cargo install [tools name]</code>，安装工具。</li>
</ul>
<h3 id="cargo-edit">cargo-edit</h3>
<p>执行<code>cargo init</code>之后，项目根目录会生成一个<code>Cargo.toml</code>文件本项目的依赖模块都会放到这里，然而手动编写这个文件对于像我这样的懒人显然是无法接受的。因此可以借助<code>cargo-edit</code>完成。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">cargo</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> cargo-edit</span></span></code></pre>
<p>记住<code>cargo-edit</code>如下命令即可。</p>
<ul>
<li><code>cargo add [module name]</code> 安装一个模块。</li>
<li><code>cargo rm [module name]</code> 删除一个模块。</li>
</ul>
<h2 id="rust-项目结构">rust 项目结构</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">-</span><span style="color:#9ECBFF"> Cargo.toml</span></span>
<span class="line"><span style="color:#B392F0">-</span><span style="color:#9ECBFF"> Cargo.lock</span></span>
<span class="line"><span style="color:#B392F0">-</span><span style="color:#9ECBFF"> src</span></span>
<span class="line"><span style="color:#B392F0">--</span><span style="color:#9ECBFF"> main.rs</span><span style="color:#6A737D"> # 项目入口文件</span></span>
<span class="line"><span style="color:#B392F0">--</span><span style="color:#9ECBFF"> lib.rs</span><span style="color:#6A737D"> # 如果作为封装成一个crate，这里配置可以暴露的模块</span></span>
<span class="line"><span style="color:#B392F0">--</span><span style="color:#9ECBFF"> bin/</span><span style="color:#6A737D"> # 项目工具文件</span></span>
<span class="line"><span style="color:#B392F0">---</span><span style="color:#9ECBFF"> helper.rs</span></span></code></pre>
<h2 id="语法速记">语法速记</h2>
<h3 id="函数">函数</h3>
<p>rust 的函数还比较有趣，它的<code>return</code>关键字是默认省略的，如果这个函数没有中断，这个函数的最后一行就是返回值，且这一行不带分号。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> index</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#F97583"> impl</span><span style="color:#B392F0"> Responder</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"hello"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>如果这个函数没写返回值，其实编译器还会让这个函数返回一个<code>()</code>。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"hello world"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    ()</span><span style="color:#6A737D"> // 此处不加()编译器还是会默认理解为返回()。</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>这么做确实比较符合函数编程的概念，但是一般 rust 库里面的函数都会返回 Result 或者 Option 类型，就用 Result 类型做例子，一般会有四种处理方式。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> bar </span><span style="color:#F97583">=</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Panic!"</span><span style="color:#E1E4E8">);</span><span style="color:#6A737D"> // 直接中断程序</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> bar </span><span style="color:#F97583">=</span><span style="color:#F97583"> match</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(value) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Some</span><span style="color:#E1E4E8">(value),</span></span>
<span class="line"><span style="color:#B392F0">    Err</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Some</span><span style="color:#E1E4E8">(someError)</span></span>
<span class="line"><span style="color:#E1E4E8">};</span><span style="color:#6A737D"> // 通过match判断处理错误， 类似于其他语言的switch-case</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> bar </span><span style="color:#F97583">=</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span><span style="color:#6A737D"> // 把错误处理交给bar</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> bar </span><span style="color:#F97583">=</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap_or</span><span style="color:#E1E4E8">();</span><span style="color:#6A737D"> // 成功返回成功值，失败返回unwrap_or的值</span></span></code></pre>
<h3 id="模块">模块</h3>
<p>通常想要使用一个模块，只需要使用<code>use</code>关键字。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">env;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> db_url </span><span style="color:#F97583">=</span><span style="color:#F97583"> match</span><span style="color:#B392F0"> env</span><span style="color:#F97583">::</span><span style="color:#B392F0">var</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"DB_URL"</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        Ok</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> { </span><span style="color:#9ECBFF">"OK"</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_owned</span><span style="color:#E1E4E8">() }</span></span>
<span class="line"><span style="color:#B392F0">        Err</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> { </span><span style="color:#9ECBFF">"Err"</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_owned</span><span style="color:#E1E4E8">() }</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{}"</span><span style="color:#E1E4E8">, db_url);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>如果引用的这个包是个非 rust 标准包（一个 crate，这里说的是我的理解，如果有个官方中文说法，以它为准），需要在添加<code>extern crate</code>关键字，如果还引用了宏，还要加上<code>#[macro_use]</code>（这就比较坑了，我哪知道到底用没用上宏，所以一般我都靠编辑器帮我编译一下…）。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">#[macro_use]</span></span>
<span class="line"><span style="color:#F97583">extern</span><span style="color:#F97583"> crate</span><span style="color:#E1E4E8"> log;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    info!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"debug"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>如果只是引用本项目相对地址的文件，使用<code>mod</code>关键字就好，可以看我的<a href="https://github.com/gongbaodd/rust_webAssembly_study/tree/master/actix_log" rel="noopener noreferrer nofollow" target="_blank">actix_log</a>。</p>
<h4 id="为啥-rust-的模块这么复杂">为啥 rust 的模块这么复杂</h4>
<p>我猜测毕竟 rust 是对标 C 语言的，相比于很多高级语言的链接工作是在虚拟机里面做的，rust 则全部下放到语言里面，所以一起用起来就会比较复杂。</p>
<h2 id="trait">trait</h2>
<p>trait 是 rust 上面的一个新概念，类似于 JS 的 mixin 和 Java 的接口，后面我会按例子来讲。</p>
<p>很多库的 trait 需要单独引用，否则会编译失败，这些库往往会封装成一个 prelude 使用。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> gtk</span><span style="color:#F97583">::</span><span style="color:#B392F0">prelude</span><span style="color:#F97583">::*</span><span style="color:#E1E4E8">;</span></span></code></pre>
<h2 id="rust-command">rust command</h2>
<p>rust 是个系统级语言，可以互相访问其他程序语言分享的堆内存空间，FFI 依靠的是 Box，但是本篇暂时不提及，这个<a href="https://github.com/gongbaodd/rust_webAssembly_study/tree/master/command" rel="noopener noreferrer nofollow" target="_blank">代码</a>实现的是读取并处理其它语言的 std 输出。</p>
<h2 id="actix_web">Actix_web</h2>
<p><a href="https://actix.rs/" rel="noopener noreferrer nofollow" target="_blank">actix-web</a>是 Rust 的 web 框架之一，试用了一下，很好上手，有一点 Express 的味道。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">cargo</span><span style="color:#9ECBFF"> add</span><span style="color:#9ECBFF"> actix-web</span></span>
<span class="line"><span style="color:#B392F0">cargo</span><span style="color:#9ECBFF"> add</span><span style="color:#9ECBFF"> actix_rt</span></span></code></pre>
<p>官网首页的例子即是一个简单的应用。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> actix</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    web,</span></span>
<span class="line"><span style="color:#B392F0">    App</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    HttpServer</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Responder</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    HttpRequest</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> greet</span><span style="color:#E1E4E8">(req</span><span style="color:#F97583">:</span><span style="color:#B392F0"> HttpRequest</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> impl</span><span style="color:#B392F0"> Responder</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> req</span><span style="color:#F97583">.</span><span style="color:#B392F0">match_info</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"name"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">unwrap_or</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"World"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello {}!"</span><span style="color:#E1E4E8">, name)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[actix_rt]</span></span>
<span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">io</span><span style="color:#F97583">::</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">&#x3C;()> {</span></span>
<span class="line"><span style="color:#B392F0">    HttpServer</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">        ||</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            App</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">                .</span><span style="color:#B392F0">route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"/"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">web</span><span style="color:#F97583">::</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to</span><span style="color:#E1E4E8">(greet))</span></span>
<span class="line"><span style="color:#F97583">                .</span><span style="color:#B392F0">route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"/{name}"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">web</span><span style="color:#F97583">::</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to</span><span style="color:#E1E4E8">(greet))</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"127.0.0.1:8080"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">?</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    .await</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>当然，如果觉得路由的部分比较难写，还可以使用宏来修改。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">#[get(</span><span style="color:#9ECBFF">"/"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> greet</span><span style="color:#E1E4E8">(req</span><span style="color:#F97583">:</span><span style="color:#B392F0"> HttpRequest</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> impl</span><span style="color:#B392F0"> Responder</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> req</span><span style="color:#F97583">.</span><span style="color:#B392F0">match_info</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"name"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">unwrap_or</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"World"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hello {}!"</span><span style="color:#E1E4E8">, name)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">App</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">route</span><span style="color:#E1E4E8">(greet);</span></span></code></pre>
<h3 id="利用中间件处理日志和错误">利用中间件处理日志和错误</h3>
<p>log 和 env_logger 是 rust 的日志工具，基本上都是宏。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>cargo add log</span></span>
<span class="line"><span>cargo add env_logger</span></span></code></pre>
<p>actix-web 使用 wrap 方法添加中间件，如添加 Logger 打出标准访问日志。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> actix_web</span><span style="color:#F97583">::</span><span style="color:#B392F0">middleware</span><span style="color:#F97583">::</span><span style="color:#B392F0">Logger</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">io</span><span style="color:#F97583">::</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">&#x3C;()> {</span></span>
<span class="line"><span style="color:#B392F0">    std</span><span style="color:#F97583">::</span><span style="color:#B392F0">env</span><span style="color:#F97583">::</span><span style="color:#B392F0">set_var</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"RUST_LOG"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"actix_web=info,info"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    env_logger</span><span style="color:#F97583">::</span><span style="color:#B392F0">init</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> url </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "127.0.0.1:8080"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> app </span><span style="color:#F97583">=</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        App</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">wrap</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Logger</span><span style="color:#F97583">::</span><span style="color:#B392F0">default</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">wrap</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Logger</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"%a %{User-Agent}i"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">wrap</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">middleware</span><span style="color:#F97583">::</span><span style="color:#B392F0">DefaultHeaders</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">header</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"X-Version"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"0.2"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">wrap</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ErrorHandlers</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">handler</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">http</span><span style="color:#F97583">::</span><span style="color:#B392F0">StatusCode</span><span style="color:#F97583">::</span><span style="color:#79B8FF">INTERNAL_SERVER_ERROR</span><span style="color:#E1E4E8">, render_500))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">service</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">routes</span><span style="color:#F97583">::</span><span style="color:#B392F0">index</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">index)</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> server </span><span style="color:#F97583">=</span><span style="color:#B392F0"> HttpServer</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(app)</span><span style="color:#F97583">.</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> wait_server </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> server</span><span style="color:#F97583">?.</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    info!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Running Server on {}"</span><span style="color:#E1E4E8">, url);</span></span>
<span class="line"><span style="color:#E1E4E8">    wait_server</span><span style="color:#F97583">.await</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>错误处理，详细代码可以查看<a href="https://github.com/gongbaodd/rust_webAssembly_study/tree/master/actix_log" rel="noopener noreferrer nofollow" target="_blank">actix-log</a>。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> render_500</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">B</span><span style="color:#E1E4E8">>(</span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> res</span><span style="color:#F97583">:</span><span style="color:#B392F0"> dev</span><span style="color:#F97583">::</span><span style="color:#B392F0">ServiceResponse</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">B</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ErrorHandlerResponse</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">B</span><span style="color:#E1E4E8">>> {</span></span>
<span class="line"><span style="color:#E1E4E8">    res</span><span style="color:#F97583">.</span><span style="color:#B392F0">response_mut</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">headers_mut</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">insert</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">        http</span><span style="color:#F97583">::</span><span style="color:#B392F0">header</span><span style="color:#F97583">::</span><span style="color:#79B8FF">CONTENT_TYPE</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">        http</span><span style="color:#F97583">::</span><span style="color:#B392F0">HeaderValue</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_static</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ErrorHandlerResponse</span><span style="color:#F97583">::</span><span style="color:#B392F0">Response</span><span style="color:#E1E4E8">(res))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="使用-serde-返回-json">使用 serde 返回 JSON</h3>
<p>想要制作 Restful API，JSON 支持是少不了的。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">cargo</span><span style="color:#9ECBFF"> add</span><span style="color:#9ECBFF"> serde</span></span></code></pre>
<p>由于 actix-web 对路由回应格式的支持，一个 json 文件可以这么写。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> acrix_web</span><span style="color:#F97583">:</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#B392F0">    HttpResponse</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Responder</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    get,</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> serde</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#B392F0">    Serialize</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Deserialize</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Serialize</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Deserialize</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> MyObj</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    message</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[get(</span><span style="color:#9ECBFF">"/hello"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> hello</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#F97583"> impl</span><span style="color:#B392F0"> Responder</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    HttpResponse</span><span style="color:#F97583">::</span><span style="color:#B392F0">Ok</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">json</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">MyObj</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        message</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> "SUCCESS"</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>更多详细的代码可以查看我的<a href="https://github.com/gongbaodd/rust_webAssembly_study/tree/master/actixweb" rel="noopener noreferrer nofollow" target="_blank">github</a>。</p>
<h2 id="diesel-处理-ormsqlite">diesel 处理 ORM(sqlite)</h2>
<p>强烈安利大家去看一下 diesel 的<a href="http://diesel.rs/guides/getting-started/" rel="noopener noreferrer nofollow" target="_blank">Get Start</a>，确实是一种下一代 ORM 的感觉。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">cargo</span><span style="color:#9ECBFF"> add</span><span style="color:#9ECBFF"> diesel</span></span></code></pre>
<h3 id="diesel_cli">diesel_cli</h3>
<p>diesel_cli 是 diesel 的命令行工具，提供数据部署和 schema 生成的功能，如果不指定 feature 的话，安装时会同时编译 sqlite、postgreSQL 以及 MySQL。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">cargo</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> diesel_cli</span><span style="color:#79B8FF"> --no-default-features</span><span style="color:#79B8FF"> --features</span><span style="color:#9ECBFF"> sqlite</span></span></code></pre>
<p>第一次编译的时候，在 Windows 下面失败了，翻了一下<a href="https://github.com/diesel-rs/diesel/issues/487" rel="noopener noreferrer nofollow" target="_blank">issue</a>找到了解决方案。</p>
<p>首先安装 Visual Studio（反正现在免费安），使用 VS 的终端打开 sqlite 文件夹。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">cd</span><span style="color:#E1E4E8"> C:\ProgramData\chocolatey\lib\SQLite\tools</span></span>
<span class="line"><span style="color:#E1E4E8">lib /def:sqlite3.def /out:sqlite3.lib</span></span></code></pre>
<p>然后记得把<code>C:\ProgramData\chocolatey\lib\SQLite\tools</code>放到环境变量 PATH 里面。</p>
<p>再次编译即可，具体如何使用 diesel 的 get start 已经足够了，在此不做赘述，可以查看<a href="https://github.com/gongbaodd/rust_webAssembly_study/tree/master/diesel_demo" rel="noopener noreferrer nofollow" target="_blank">源码</a>。</p>
<p>这里列举一下经常用的命令</p>
<ul>
<li><code>diesel setup</code> 初始化。</li>
<li><code>diesel migration generate [step name]</code> 生成 down.sql 和 up.sql。</li>
<li><code>diesel migration run</code> 按照 SQL 文件部署数据库和 schema 文件（目前发现一个 bug，生成的 schema 不完全，没能完全复现）。</li>
<li><code>diesel migration revert</code> 撤回数据库操作。</li>
</ul>
<h3 id="补充一下-rust-语法里面的生命周期">补充一下 rust 语法里面的生命周期</h3>
<p>demo 里面的 lib 文件 create_post 语法很奇怪。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> create_post</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">>(conn</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">SqliteConnection</span><span style="color:#E1E4E8">, title</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#B392F0"> str</span><span style="color:#E1E4E8">, body</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#B392F0"> str</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> usize</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#B392F0"> schema</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">posts;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> new_post </span><span style="color:#F97583">=</span><span style="color:#B392F0"> NewPost</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        title</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> title,</span></span>
<span class="line"><span style="color:#E1E4E8">        body</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> body,</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    diesel</span><span style="color:#F97583">::</span><span style="color:#B392F0">insert_into</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">posts</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">table)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">values</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">new_post)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">execute</span><span style="color:#E1E4E8">(conn)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error saving new post"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>&#x3C;'a></code>的写法是指明函数的生命周期标注，因为 rust 没有垃圾回收机制，所有申请的堆内存在一个函数执行结束后就会回收。所以当一个函数的输入值是堆内存的变量，就发生「借用」，如这个函数里面的三个参数，借用都用<code>&#x26;</code>来标注。</p>
<p>假设一个变量借出给另一个函数，而在借用变量的函数执行阶段借出函数就结束并销毁变量，程序就会出错，因此生命周期就是用来确定一个借出的变量必须还回后才能被销毁。默认 rust 都会给一个生命周期，然而当出现两个以上生命周期时，如<code>create_post</code>则需要程序员指定参数必须在一个生命周期内。</p>
<h2 id="juniper-实现-graphql">juniper 实现 graphql</h2>
<p>写一个 Query 的方法</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">#[derive(juniper</span><span style="color:#F97583">::</span><span style="color:#B392F0">GraphQLObject</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> MyObj</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    name</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> QueryRoot</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">#[derive(juniper</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">object)]</span></span>
<span class="line"><span style="color:#F97583">impl</span><span style="color:#B392F0"> QueryRoot</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> myObj</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#B392F0"> juniper</span><span style="color:#F97583">::</span><span style="color:#B392F0">FieldResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">MyObj</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            name</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> "World"</span></span>
<span class="line"><span style="color:#E1E4E8">        })</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Mutation 也类似，基本很简单，可以查看<a href="https://github.com/gongbaodd/rust_webAssembly_study/blob/master/graphql_only" rel="noopener noreferrer nofollow" target="_blank">代码</a>了解。</p>
<h3 id="rust-语法里面闭包里面-move-的使用">rust 语法里面闭包里面 move 的使用</h3>
<p>前面说过，如果一个函数想调用另一个函数的堆内存，可以借用。但是还有另一种函数，闭包，理论上闭包可以处理闭包所在词法作用域下的所有变量。在动态执行时如果闭包中依赖的一个变量已经销毁也是很危险的事儿，所以这里可以用 move 关键字将变量所有权交给闭包，在闭包外则无权再次处理已经 move 的变量。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#B392F0"> io</span><span style="color:#F97583">::</span><span style="color:#B392F0">Result</span><span style="color:#E1E4E8">&#x3C;()> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> schema </span><span style="color:#F97583">=</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">sync</span><span style="color:#F97583">::</span><span style="color:#B392F0">Arc</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">create_schema</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> app </span><span style="color:#F97583">=</span><span style="color:#F97583"> move</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        App</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">data</span><span style="color:#E1E4E8">(schema</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">wrap</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">middleware</span><span style="color:#F97583">::</span><span style="color:#B392F0">Logger</span><span style="color:#F97583">::</span><span style="color:#B392F0">default</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">service</span><span style="color:#E1E4E8">(graphql)</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">service</span><span style="color:#E1E4E8">(graphiql)</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    HttpServer</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(app)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"127.0.0.1:8080"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">?</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">        .await</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>当然 graphql 的代码里面还有 RC 和 ARC 的概念，现在暂时了解他们时 Rust 下面的引用计数的一种实现，RC 用于单线程，ARC 用于多线程。</p></article><footer data-astro-cid-sz7xmlte>
&copy; 2023 宫不上, built with <span class="heart" data-astro-cid-sz7xmlte>❤️</span>. All rights reserved.
</footer></main></body></html>